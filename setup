#!/bin/bash
# Install program to user home

# TODO: Rewrite as Makefile
# TODO: Write a PKGBUILD

bin="$HOME/.local/bin"
config="$HOME/.config/arb"
systemd="$HOME/.config/systemd/user"
script=$(readlink -f "$0") # absolute script path
src=$(dirname "$script") # absolute source files path
deps=(borg git gocryptfs pass rclone rsync) # dependencies

installMany() {
# Install packages from a list
    toInstall=()
    for pkg; do pacman -Qi "$pkg" &> /dev/null || toInstall+=("$pkg"); done # select pkgs not already installed
    [[ "${toInstall[*]}" == "" ]] || ( sudo pacman -Syu && sudo pacman -S "${toInstall[@]}" ) # install select pkgs if any
}

if [ "$#" -ne 1 ]; then # HELP
    echo "Options are install and uninstall." && exit 1
fi

# INSTALL
if [ "$1" == install ]; then
    installMany "${deps[@]}" # install pkgs
    mkdir -p "$bin" && cp "$src/arb" "$bin/arb" # copy bin
    mkdir -p "$config" && cp -n "$src/config" "$src/template.ignore" "$config/" # copy data (don't overwrite)
    mkdir -p "$systemd" && cp "$src/arb.service" "$src/arb.timer" "$systemd/" && systemctl --user daemon-reload # setup systemd
    exit 0
fi

# UNINSTALL
if [ "$1" == unistall ]; then
    rm -f "$bin/arb" # remove bins
    systemctl --user stop arb && systemctl --user disable arb && systemctl --user disable arb.timer # disable service
    rm -f "$systemd/arb.service" && rm -f "$systemd/arb.timer" && systemctl --user daemon-reload # remove service
    exit 0
fi
