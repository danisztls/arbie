#!/bin/bash
# A.R.B. Configuration File
# ENVIRONMENT
config="$HOME/config/arb"

# System
system_repo="$HOME/.archive/system"         # system repository
system_exclude="audisp brlapi.key ca-certificates crypttab default/useradd gshadow* iptables libaudit.conf mtab NetworkManager/system-connections pacman.d/gnupg polkit-1 .pwd.lock shadow* sudoers sudoers.d ufw"              # system exclude list

# Home
home_repo="$HOME/.archive/home"                     # borg repository
home_exclude="$config/home.ignore"           # borg exclude file
home_pass="home"                            # gocryptfs password
home_rsync="/mnt/backup/name"               # rsync destination dir
home_rclone=(nextcloud onedrive amazons3)   # rclone destination streams

# TASKS
# System Archive
archiveSys "$system_repo" "$system_exclude" & child=$! && wait $child

# Borg Archive
archiveBorg "$home_repo" "$home_exclude" "$HOME" & child=$! && wait $child

# Repo Sync to Disk
syncDisk "$home_repo" "$home_rsync" & child=$! && wait $child

# Repo Sync to Cloud
mountCrypt "home" "$home_repo" "$home_pass" || exit 1
for stream in "${home_rclone[@]}"; do
    syncCloud "home" "$stream" & child=$! && wait $child
done

# TODO: Move for loop to arb
# TODO: Use getopts to make program flow less fragile
# TODO: Always pass name to improve determinism and logging
