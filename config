#!/bin/bash
# A.R.B. Configuration File
# ENVIRONMENT
config="$HOME/config/arb"

# System
system_repo="$HOME/.archive/system"         # system repository
system_exclude="audisp brlapi.key ca-certificates crypttab default/useradd gshadow* iptables libaudit.conf mtab NetworkManager/system-connections pacman.d/gnupg polkit-1 .pwd.lock shadow* sudoers sudoers.d ufw"              # system exclude list

# Home
home_repo="$HOME/.archive/home"                     # borg repository
home_exclude="$config/home.ignore"           # borg exclude file
home_pass="home"                            # gocryptfs password
home_rsync="/mnt/backup/name"               # rsync destination dir
home_rclone=(nextcloud onedrive amazons3)   # rclone destination streams

# TASKS
# System Archive
archiveSys "$system_repo" "$system_exclude" & child=$! && wait $child

# Borg Archive
archiveBorg "$home_repo" "$home_exclude" "$HOME" & child=$! && wait $child

# Repo Sync to Disk
syncDisk "$home_repo" "$home_rsync" & child=$! && wait $child

# Repo Sync to Cloud
mountCrypt "home" "$home_repo" "$home_pass" || exit 1
syncCloud "home" "$home_rclone" & child=$! && wait $child
umountCrypt "home"

# TODO: Use getopts to make arguments less fragile.
# TODO: Always pass name to improve determinism.
# TODO: Is it possible to move child PID parsing and wait to main?
# TODO: Encryption should be automatically done by main and config could be simplified to a encryption tag.
